alter table if exists public.deals add column if not exists position integer not null default 0; create index if not exists idx_deals_user_stage_position on public.deals(user_id,stage,position); create or replace function public.deals_position_set() returns trigger as $$ begin if new.position is null or new.position=0 then select coalesce(max(position),-1)+1 into new.position from public.deals where user_id=new.user_id and stage=new.stage; end if; return new; end; $$ language plpgsql; drop trigger if exists trg_deals_position_set on public.deals; create trigger trg_deals_position_set before insert on public.deals for each row execute function public.deals_position_set();